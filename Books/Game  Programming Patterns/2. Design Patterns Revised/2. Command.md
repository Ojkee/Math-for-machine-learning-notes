Replacement for callbacks.

### Problem
Actions are hard-wired to their receivers.
![[Pasted image 20250809131818.png]]
![[Pasted image 20250809131831.png]]

### Solution 
Wrap actions in command objects, allowing them to be stored, queued, and executed later
![[Pasted image 20250809132057.png]]
#### Actions
```cpp
class Command {
public:
	virtual ~Command() = default;
	virtual void execute(GameActor& actor) = 0;
};
```

```cpp
class JumpCommand : public Command {
public:
	void execute(GameActor& actor) override { actor.jump(); }
};
```
```cpp
class FireCommand : public Command {
public:
	void execute(GameActor& actor) override { actor.fire_gun(); }
};
```
```cpp
// And so on
```

#### Handler
```cpp
class InputHandler {
public:
	Command* handle_input();
	
	// Bind Action Commands

private:
	Command* m_button_X;
	Command* m_button_Y;
	Command* m_button_A;
	Command* m_button_B;
};
```
```cpp
Command* InputHandler::handle_input() {
	if (is_pressed(BUTTON_X)) return m_button_X;
	if (is_pressed(BUTTON_Y)) return m_button_Y;
	if (is_pressed(BUTTON_A)) return m_button_A;
	if (is_pressed(BUTTON_B)) return m_button_B;
	return NULL; // NullCommand
}
```

### Executing
```cpp
Command* command = input_handler.handle_input();
if (command) {
	command->execute(actor);
}
```

### Undo and Redo

```cpp
class Command {
public:
	virtual ~Command() {}
	virtual void execute() = 0;
	virtual void undo() = 0;
}
```

```cpp
class MoveUnitCommand : public Command {
public:
	MoveUnitCommand(Unit* unit, int x, int y) 
	: m_unit(unit),
	  m_x(x),
	  m_y(x),
	  m_x_before(0),
	  m_y_before(0) {}
	  
	virtual void execute() {
		m_x_before = unit->x();
		m_y_before = unit->y();
		m_unit->move_to(m_x, m_y);
	}

	virtual void undo() {
		m_unit->move_to(m_x_before, m_y_before);
	}

private:
	Unit* m_unit;
	int m_x{};
	int m_y{};
	int m_x_before{};
	int m_y_before{};
}
```

```cpp
Command* handle_input() {
	Unit* unit = get_selected_unit();
	
	if (is_pressed(BUTTON_UP)) {
		int dest_y = unit->y() - 1;
		return new MoveUnitCommand(unit, unit->x(), dest_y);
	}
	
	if (is_pressed(BUTTON_DOWN)) {
		int dest_y = unit->y() + 1;
		return new MoveUnitCommand(unit, unit->x(), dest_y);
	}

	return NULL;
}
```